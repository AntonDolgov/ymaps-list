"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,o){for(var s=0;s<o.length;s++){var e=o[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(o,s,e){return s&&t(o.prototype,s),e&&t(o,e),o}}();function _classCallCheck(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}var Ylist=function(){function t(o){_classCallCheck(this,t),this.options=o,this.map=null,o.hasOwnProperty("data")?this.points=this.options.data:this.points=null,this.placemarks=[],this.activePlacemark=null,this.activeListItem=null,this.clusterer=null,this.balloonLayout=null,this.balloonParams={balloonWidth:null,balloonHeight:null,balloonTailHeight:15},this.listClassName="ylist-list",this.isLessThanAdaptiveBreakpoint=!1,this.mqlAdaptiveBreakpoint=window.matchMedia("(max-width: "+(this.options.adaptiveBreakpoint-1)+"px)"),this.needReloadMap=!0}return _createClass(t,[{key:"init",value:function(){this._checkRequiredOptions();var t=this;ymaps.ready(function(){t.mqlAdaptiveBreakpoint.addListener(function(){t._adaptiveHandle(this,t)}),t._adaptiveHandle(t.mqlAdaptiveBreakpoint,t)}),this.options.list&&this._initList()}},{key:"_checkRequiredOptions",value:function(){this.points?!this.options.hasOwnProperty("dataOrder")||this.options.hasOwnProperty("dataOrder")&&0==this.options.dataOrder.length?console.log("You need to set dataOrder option"):this.options.hasOwnProperty("container")?this.options.hasOwnProperty("mapCenter")?this.options.hasOwnProperty("mapContainer")?(this.options.hasOwnProperty("list")||(this.options.list=!1),this.options.hasOwnProperty("list")&&this.options.list&&!this.options.hasOwnProperty("listContainer")?console.log("You need to set listContainer option"):(this.options.hasOwnProperty("listScroll")||(this.options.listScroll=!1),this.options.hasOwnProperty("listParams")||(this.options.listParams={}),this.options.hasOwnProperty("listParams")&&"object"==_typeof(this.options.listParams)&&(this.options.listParams.hasOwnProperty("showHeader")||(this.options.listParams.showHeader=!0)),this.options.hasOwnProperty("switchContainer")||(this.options.switchContainer=!1),this.options.hasOwnProperty("cluster")||(this.options.cluster={}),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&!this.options.cluster.hasOwnProperty("icons")&&(this.options.cluster.icons=["islands#invertedRedClusterIcons","islands#invertedBlueClusterIcons"]),this.options.hasOwnProperty("cluster")&&"object"==_typeof(this.options.cluster)&&!this.options.cluster.hasOwnProperty("inlineStyle")&&(this.options.cluster.inlineStyle=""),this.options.hasOwnProperty("balloonParams")||(this.options.balloonParams={}),this.options.hasOwnProperty("balloonParams")&&"object"==_typeof(this.options.balloonParams)&&(this.options.balloonParams.hasOwnProperty("showHeader")||(this.options.balloonParams.showHeader=!0),this.options.balloonParams.hasOwnProperty("overflowVisible")||(this.options.balloonParams.overflowVisible=!1),this.options.balloonParams.hasOwnProperty("closeButton")||(this.options.balloonParams.closeButton="x")),this.options.hasOwnProperty("balloonBeforeBreakpoint")||(this.options.balloonBeforeBreakpoint=!1),this.options.hasOwnProperty("balloonAfterBreakpoint")||(this.options.balloonAfterBreakpoint=!1),this.options.hasOwnProperty("adaptiveBreakpoint")||(this.options.adaptiveBreakpoint=1024),this.options.hasOwnProperty("drag")||(this.options.drag={}),this.options.hasOwnProperty("drag")&&"object"==_typeof(this.options.drag)&&(this.options.drag.hasOwnProperty("disableMobile")||(this.options.drag.disableMobile=!0),this.options.drag.hasOwnProperty("disableDesktop")||(this.options.drag.disableDesktop=!1)),this.options.hasOwnProperty("placemark")||(this.options.placemark={}),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&!this.options.placemark.hasOwnProperty("icons")&&(this.options.placemark.icons=["islands#redDotIcon","islands#blueDotIcon"]),this.options.hasOwnProperty("placemark")&&"object"==_typeof(this.options.placemark)&&!this.options.placemark.hasOwnProperty("clicked")&&(this.options.placemark.clicked=!0))):console.log("You need to set mapContainer option"):console.log("You need to set mapCenter option"):console.log("You need to set container option"):console.log("You need to JSON data")}},{key:"_initMap",value:function(){var t=$("#"+this.options.mapContainer);if(this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null),!t.find(".ylist-tooltip").length){var o=$('<div class="ylist-tooltip">\n                    <span class="ylist-tooltip__text">Чтобы переместить карту, проведите по ней двумя пальцами</span>\n                </div>');t.append(o)}this.map=new ymaps.Map(this.options.mapContainer,{center:this.options.mapCenter,zoom:13,controls:[]});var s=new ymaps.control.ZoomControl({options:{size:"small",position:{top:10,right:10}}});if(this.map.controls.add(s),this.map.behaviors.disable("scrollZoom"),this._createPlacemarks(),"boolean"!=typeof this.options.cluster||this.options.cluster?(this._createClusterer(),this._addClusterer(),this._setBounds(this.clusterer)):(this._addPlacemarks(),this._setBounds(this.map.geoObjects)),this.isLessThanAdaptiveBreakpoint&&!0===this.options.drag.disableMobile){var e=$("#"+this.options.mapContainer),i=e.find(".ylist-tooltip");this.map.behaviors.disable("drag"),e.on("touchmove",function(t){1==t.originalEvent.touches.length?i.css("opacity","1"):i.css("opacity","0")}).on("touchstart",function(t){i.css("opacity","0")}).on("touchend",function(t){i.css("opacity","0")}).on("touchleave",function(t){i.css("opacity","0")}).on("touchcancel",function(t){i.css("opacity","0")})}this.isLessThanAdaptiveBreakpoint||!0!==this.options.drag.disableDesktop||this.map.behaviors.disable("drag"),this.needReloadMap=!1}},{key:"_destroyMap",value:function(){this.map&&(this.map.destroy(),this.map=null,this.placemarks=[],this.activePlacemark=null,this.clusterer=null,this.balloonLayout=null)}},{key:"_initList",value:function(){this._createPointsList()}},{key:"_createPlacemarks",value:function(){for(var t=this,o=0;o<this.points.length;o++){var s=void 0;s=this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&this.options.placemark.clicked||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked?this._setBalloonData(o):{};var e=this.points[o],i=new ymaps.Placemark(e.coords,s,this._setPlacemarkOptions(o));i.id=e.id,i.events.add("click",function(o){t._placemarkClickHandler(o,t)}),this.activeListItem&&this.activeListItem==e.id&&("string"==typeof this.options.placemark.icons[0]?i.options.set("preset",this.options.placemark.icons[1]):i.options.set("iconImageHref",this.options.placemark.icons[1].href),i.isActive=!0),this.placemarks.push(i)}}},{key:"_addPlacemarks",value:function(){for(var t=0;t<this.placemarks.length;t++)this.map.geoObjects.add(this.placemarks[t])}},{key:"_setPlacemarkOptions",value:function(t){var o={};return"string"==typeof this.options.placemark.icons[0]?o.preset=this.options.placemark.icons[0]:(o.iconLayout="default#image",o.iconImageHref=this.options.placemark.icons[0].href,o.iconImageSize=this.options.placemark.icons[0].size,o.iconImageOffset=this.options.placemark.icons[0].offset),(this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&this.options.placemark.clicked||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint&&this.options.placemark.clicked)&&(o.balloonLayout=this._createBalloonLayout(),o.balloonContentLayout=this._createBalloonContentLayout(),o.balloonAutoPan=!1,o.balloonShadow=!1,o.balloonPanelMaxMapArea=0),this.options.placemark.clicked||(o.cursor="default"),o}},{key:"_createClusterer",value:function(){if(this.clusterer&&this.clusterer.removeAll(),this.clusterer=new ymaps.Clusterer({groupByCoordinates:!1,clusterDisableClickZoom:!1,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,zoomMargin:40}),"string"==typeof this.options.cluster.icons[0])this.clusterer.options.set({preset:this.options.cluster.icons[0]});else{var t=ymaps.templateLayoutFactory.createClass('<div style="'+this.options.cluster.inlineStyle+'">{{ properties.geoObjects.length }}</div>');this.clusterer.options.set({clusterIcons:this.options.cluster.icons[0],clusterNumbers:[100],clusterIconContentLayout:t})}this.clusterer.add(this.placemarks)}},{key:"_addClusterer",value:function(){this.map.geoObjects.add(this.clusterer)}},{key:"_createBalloonLayout",value:function(){var t=this;return ymaps.templateLayoutFactory.createClass('<div class="ylist-balloon">\n                <button class="ylist-balloon__close" type="button">'+this.options.balloonParams.closeButton+'</button>\n                <div class="ylist-balloon__inner">\n                    $[[options.contentLayout]]\n                </div>\n            </div>',{build:function(){this.constructor.superclass.build.call(this),this._$element=$(".ylist-balloon",this.getParentElement()),this.applyElementOffset(),this._$element.find(".ylist-balloon__close").on("click",$.proxy(this.onCloseClick,this)),t.balloonParams.balloonWidth=this._$element[0].offsetWidth,t.balloonParams.balloonHeight=this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight},clear:function(){this._$element.find(".ylist-balloon__close").off("click"),this.constructor.superclass.clear.call(this)},onSublayoutSizeChange:function(){this.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments),this._isElement(this._$element)&&(this.applyElementOffset(),this.events.fire("shapechange"))},applyElementOffset:function(){this._$element.css({left:-this._$element[0].offsetWidth/2,top:-(this._$element[0].offsetHeight+t.balloonParams.balloonTailHeight)})},onCloseClick:function(t){t.preventDefault(),this.events.fire("userclose")},_isElement:function(t){return t&&t[0]&&t.find(".ylist-balloon__inner")[0]}})}},{key:"_createBalloonContentLayout",value:function(){var t="";return t=!1===this.options.balloonParams.showHeader?'<div class="ylist-balloon__content">$[properties.balloonContent]</div>':'<h3 class="ylist-balloon__title">$[properties.balloonHeader]</h3>\n                                    <div class="ylist-balloon__content">$[properties.balloonContent]</div>',this.options.balloonParams.hasOwnProperty("setValue")&&"function"==typeof this.options.balloonParams.setValue&&(t=this.options.balloonParams.setValue(t)),ymaps.templateLayoutFactory.createClass(t)}},{key:"_setBalloonData",value:function(t){for(var o="",s=0;s<this.options.dataOrder.length;s++){var e=this.options.dataOrder[s];"object"===(void 0===e?"undefined":_typeof(e))&&null!==e?("function"!=typeof e.setValue&&console.error("Значение setValue должно быть функцией!"),o+='<p class="ylist-balloon__'+e.name+'">'+e.setValue(this.points[t][e.name])+"</p>"):o+='<p class="ylist-balloon__'+e+'">'+this.points[t][e]+"</p>"}return{balloonHeader:this.points[t].name,balloonContent:o}}},{key:"_createListElement",value:function(t){var o=$("<h3/>",{class:this.listClassName+"__title"}),s="",e=$("<li/>",{id:t.id,class:this.listClassName+"__item"});"string"==typeof t.name&&!1!==this.options.listParams.showHeader?o.html("<a>"+t.name+"</a>"):o=null;for(var i=0;i<this.options.dataOrder.length;i++){var a=this.options.dataOrder[i];"object"===(void 0===a?"undefined":_typeof(a))&&null!==a?("function"!=typeof a.setValue&&console.error("Значение setValue должно быть функцией!"),s+='<p class="'+this.listClassName+"__"+a.name+'">'+a.setValue(t[a.name])+"</p>"):s+='<p class="'+this.listClassName+"__"+a+'">'+t[a]+"</p>"}return this.options.listParams.hasOwnProperty("setValue")&&"function"==typeof this.options.listParams.setValue&&(s=this.options.listParams.setValue(s)),e.append(o,s),e}},{key:"_createPointsList",value:function(){for(var t=this,o=$("<ul/>",{class:this.listClassName}),s=0;s<this.points.length;s++){var e=this.points[s];o.append(this._createListElement(e))}$("#"+this.options.listContainer).html("").append(o),$(document).on("click","."+t.listClassName+"__title",function(o){var s=$(this).closest("."+t.listClassName+"__item").attr("id");if(t.placemarks.length>0)for(var e=0;e<t.placemarks.length;e++){var i=t.placemarks[e];if(i.id==s){t._listItemClickHandler(o,i);break}}else t._listItemClickHandler(o,s)})}},{key:"_setBounds",value:function(t){"object"===_typeof(this.placemarks)&&1===this.placemarks.length?this.map.setCenter(this.placemarks[0].geometry.getCoordinates(),16):this.map.setBounds(t.getBounds(),{checkZoomRange:!0,zoomMargin:10})}},{key:"_placemarkClickHandler",value:function(t,o){if(this.options.placemark.clicked){var s=t.get("target");if(o.activePlacemark=s,this._commonClickHandler(s),this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint||this.options.balloonBeforeBreakpoint&&!this.options.balloonAfterBreakpoint&&this.isLessThanAdaptiveBreakpoint||!this.options.balloonBeforeBreakpoint&&this.options.balloonAfterBreakpoint&&!this.isLessThanAdaptiveBreakpoint){if(!0===this.options.balloonParams.overflowVisible){var e=function(t){"outerBalloon"===s.options.get("balloonPane")&&o._setBalloonPane(o.map,s,t.get("tick"))},i=function(t){"outerBalloon"!==s.options.get("balloonPane")&&o._setBalloonPane(o.map,s,t.get("tick"))};o.map.geoObjects.events.add("balloonopen",function(){o.map.events.add("actiontick",e),o.map.events.add("actiontickcomplete",i),o._setBalloonPane(o.map,s)}),o.map.geoObjects.events.add("balloonclose",function(){o.map.events.remove("actiontick",e),o.map.events.remove("actiontickcomplete",i)})}o.map.geoObjects.events.add("balloonopen",function t(){var e,i=void 0,a=!0===o.options.balloonParams.overflowVisible?4:2;(i=o.map.options.get("projection").toGlobalPixels(s.geometry.getCoordinates(),o.map.getZoom()))[1]-=o.balloonParams.balloonHeight/a,e=o.map.options.get("projection").fromGlobalPixels(i,o.map.getZoom()),o.map.panTo(e,{flying:!0}),o.map.geoObjects.events.remove("balloonopen",t)})}else o.map.panTo(s.geometry.getCoordinates(),{flying:!0})}}},{key:"_listItemClickHandler",value:function(t,o){if(this._commonClickHandler(o),"string"!=typeof o){if(this.activePlacemark&&this.map.getZoom()<11){var s=this.clusterer.getObjectState(this.activePlacemark).isClustered,e=this.clusterer.getObjectState(o).isClustered;if(!s&&!e)return this.map.panTo(o.geometry.getCoordinates(),{flying:!0}),void(this.activePlacemark=o)}for(var i=9===this.map.getZoom()?this.map.getZoom():9;this.map.setCenter(o.geometry.getCoordinates(),i++),this.clusterer.getObjectState(o).isClustered;);this.activePlacemark=o}}},{key:"_commonClickHandler",value:function(t){var o=null,s=null,e=null;if(this.options.list&&(o=$("#"+this.options.listContainer)),"string"==typeof t)this.options.list&&(s=$("#"+t)),e=t;else{this.options.list&&(s=$("#"+t.id)),e=t.id;for(var i=0;i<this.placemarks.length;i++){var a=this.placemarks[i];"string"==typeof this.options.placemark.icons[0]?a.options.set("preset",this.options.placemark.icons[0]):a.options.set("iconImageHref",this.options.placemark.icons[0].href),a.balloon.close(),this.clusterer.getObjectState(a).cluster&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(a).cluster.options.set("preset",this.options.cluster.icons[0]):this.clusterer.getObjectState(a).cluster.options.set("clusterIcons",this.options.cluster.icons[0])),a.isActive=!1}this.clusterer.getObjectState(t).isClustered&&("string"==typeof this.options.cluster.icons[0]?this.clusterer.getObjectState(t).cluster.options.set("preset",this.options.cluster.icons[1]):this.clusterer.getObjectState(t).cluster.options.set("clusterIcons",this.options.cluster.icons[1])),"string"==typeof this.options.placemark.icons[0]?t.options.set("preset",this.options.placemark.icons[1]):t.options.set("iconImageHref",this.options.placemark.icons[1].href),t.isActive=!0}this.activeListItem=e,this.options.list&&(o.find(".is-active").removeClass("is-active"),s.addClass("is-active"),"boolean"!=typeof this.options.listScroll||this.options.listScroll?this.options.listScroll(o,s):o.scrollTop(s.position().top+o.scrollTop()))}},{key:"_adaptiveHandle",value:function(t,o){t.matches?(o.isLessThanAdaptiveBreakpoint=!0,o.needReloadMap=!0,o.options.list&&o._destroyMap(),0!=o.options.switchContainer&&($("#"+o.options.switchContainer).addClass("is-visible"),$("#"+o.options.switchContainer).find('[data-ylist-switch="list"]').addClass("is-active")),o.options.list&&$("#"+o.options.mapContainer).addClass("is-hidden"),$("#"+o.options.mapContainer).addClass("is-adaptive"),$("#"+o.options.listContainer).addClass("is-adaptive"),$("#"+o.options.container).addClass("is-adaptive"),o.options.list||o.map||o._initMap(),$(document).on("click","#"+o.options.switchContainer+" [data-ylist-switch]",function(t){o._switchHandler(t,o)})):(o.isLessThanAdaptiveBreakpoint=!1,0!=o.options.switchContainer&&($("#"+o.options.switchContainer).removeClass("is-visible"),$("#"+o.options.switchContainer).find("[data-ylist-switch]").removeClass("is-active")),$("#"+o.options.mapContainer).removeClass("is-adaptive is-hidden"),$("#"+o.options.listContainer).removeClass("is-adaptive is-hidden"),$("#"+o.options.container).removeClass("is-adaptive"),!o.options.list&&(o.options.list||o.isLessThanAdaptiveBreakpoint||o.map)||o._initMap(),$(document).off("click","#"+o.options.switchContainer+" [data-ylist-switch]",o._switchHandler))}},{key:"_switchHandler",value:function(t,o){var s=$(t.target);s.length&&!s.hasClass("is-active")&&("map"===s.attr("data-ylist-switch")?($("#"+o.options.mapContainer).removeClass("is-hidden"),$("#"+o.options.listContainer).addClass("is-hidden"),o.needReloadMap&&o._initMap()):"list"===s.attr("data-ylist-switch")&&($("#"+o.options.mapContainer).addClass("is-hidden"),$("#"+o.options.listContainer).removeClass("is-hidden")),$("#"+o.options.switchContainer).find("[data-ylist-switch]").removeClass("is-active"),s.addClass("is-active"))}},{key:"_setBalloonPane",value:function(t,o,s){s=s||{globalPixelCenter:t.getGlobalPixelCenter(),zoom:t.getZoom()};var e=t.container.getSize(),i=[[s.globalPixelCenter[0]-e[0]/2,s.globalPixelCenter[1]-e[1]/2],[s.globalPixelCenter[0]+e[0]/2,s.globalPixelCenter[1]+e[1]/2]],a=o.balloon.getPosition(),n=Math.pow(2,s.zoom-t.getZoom()),l=ymaps.util.pixelBounds.containsPoint(i,[a[0]*n,a[1]*n]),r="outerBalloon"==o.options.get("balloonPane");!l&&r?o.options.set({balloonPane:"balloon",balloonShadowPane:"shadows"}):l&&!r&&o.options.set({balloonPane:"outerBalloon",balloonShadowPane:"outerBalloon"})}}]),t}();